openapi: 3.0.3
info:
  title: Biometric Server HRIS API
  description: Production-ready secure API endpoints for HRIS integration with biometric attendance system. Features real-time webhooks, timezone synchronization, and alternating IN/OUT logic.
  version: 2.0.0
  contact:
    name: Biometric Server API Support

servers:
  - url: http://localhost:5050
    description: Local development server
  - url: http://your-server-host:5050
    description: Production server

security:
  - bearerAuth: []

paths:
  /api/auth/token:
    post:
      summary: Generate API token
      description: Generate a secure Bearer token for API authentication
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - client_id
                - client_secret
              properties:
                client_id:
                  type: string
                  description: Unique identifier for the HRIS client
                  example: "hris_system"
                client_secret:
                  type: string
                  description: Secret key for client authentication
                  example: "your_secure_secret"
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  token:
                    type: string
                    description: Bearer token for API authentication
                    example: "hris_system.1640995200.abc123..."
                  expires_in:
                    type: string
                    description: Token expiry information
                    example: "24 hours"
                  client_id:
                    type: string
                    example: "hris_system"
        '400':
          description: Bad request - missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Client not authorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/status:
    get:
      summary: Get biometric system status
      description: Retrieve comprehensive system status, device alignment, and webhook information
      tags:
        - System
      security:
        - bearerAuth: []
      responses:
        '200':
          description: System status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/logs:
    get:
      summary: Get attendance logs with timezone info
      description: Retrieve attendance logs with timezone information, device filtering, and alternating IN/OUT logic
      tags:
        - Attendance
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
          description: Maximum number of records to return
          example: 100
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
          description: Number of records to skip
          example: 0
        - name: user_id
          in: query
          schema:
            type: integer
          description: Filter by specific user ID
          example: 5
        - name: device_id
          in: query
          schema:
            type: string
          description: Filter by device ID
          example: "2401058352"
        - name: primary_only
          in: query
          schema:
            type: boolean
          description: Get only logs from primary device (2401058352)
          example: true
        - name: start_date
          in: query
          schema:
            type: string
            format: date
          description: Start date for filtering (YYYY-MM-DD)
          example: "2025-10-22"
        - name: end_date
          in: query
          schema:
            type: string
            format: date
          description: End date for filtering (YYYY-MM-DD)
          example: "2025-10-22"
      responses:
        '200':
          description: Attendance logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttendanceLogsResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/users:
    get:
      summary: Get enrolled biometric users
      description: Retrieve information about users enrolled in the biometric system
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
          description: Maximum number of users to return
          example: 100
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
          description: Number of users to skip
          example: 0
        - name: user_id
          in: query
          schema:
            type: integer
          description: Get specific user by ID
          example: 5
      responses:
        '200':
          description: Users retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsersResponse'
        '404':
          description: User not found (when user_id is specified)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/devices:
    get:
      summary: Get biometric device status
      description: Retrieve status information for all biometric devices with alignment info
      tags:
        - Devices
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Devices retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DevicesResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/sync:
    post:
      summary: Sync user data to biometric system
      description: Send user data updates from HRIS to biometric system for enrollment
      tags:
        - Synchronization
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                users:
                  type: array
                  description: Array of user objects to sync/enroll
                  items:
                    type: object
                    properties:
                      user_id:
                        type: integer
                        example: 5
                      name:
                        type: string
                        example: "John Doe"
                      department:
                        type: string
                        example: "IT"
                      enabled:
                        type: boolean
                        example: true
      responses:
        '200':
          description: Sync request processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Sync request processed"
                  received_users:
                    type: integer
                    description: Number of users received in request
                    example: 8
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/webhook/status:
    get:
      summary: Get webhook status and statistics
      description: Monitor webhook delivery health, queue status, and performance metrics
      tags:
        - Webhooks
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Webhook status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookStatus'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/manual-log:
    post:
      summary: Manual attendance log processing
      description: Send manual attendance logs that simulate real biometric device operations, including alternating IN/OUT logic, timezone conversion, and webhook delivery
      tags:
        - Testing
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - device_id
              properties:
                user_id:
                  type: integer
                  description: User ID (1-8 for primary device)
                  example: 5
                  minimum: 1
                  maximum: 8
                device_id:
                  type: string
                  description: Device ID (2401058352 = Primary, 2401058350 = Secondary)
                  example: "2401058352"
                  enum: ["2401058352", "2401058350"]
                timestamp:
                  type: string
                  description: Optional timestamp in YYYYMMDDHHMMSS format (uses current time if not provided)
                  example: "20251022141752"
                verify_mode:
                  type: integer
                  description: Verification method (1 = Fingerprint, 2 = Card, etc.)
                  example: 1
                  default: 1
                io_mode:
                  type: integer
                  description: Device-reported direction (0 = OUT, 1 = IN) - will be corrected by alternating logic
                  example: 0
                  default: 0
                test_webhook:
                  type: boolean
                  description: Whether to also test webhook delivery
                  example: false
                  default: false
      responses:
        '200':
          description: Test attendance log processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestLogResponse'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Processing error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/webhook/test:
    post:
      summary: Test webhook delivery
      description: Send a test webhook to verify delivery functionality and latency
      tags:
        - Webhooks
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Webhook test completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  webhook_test_result:
                    type: string
                    enum: [PASSED, FAILED]
                    example: "FAILED"
                  performance:
                    type: object
                    properties:
                      total_time_ms:
                        type: number
                        example: 45.2
                      webhook_time_ms:
                        type: number
                        example: 12.3
                  timestamp:
                    type: string
                    format: date-time
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/biometric/performance:
    get:
      summary: Get system performance metrics
      description: Retrieve detailed performance statistics including cache usage and webhook metrics
      tags:
        - Monitoring
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Performance metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceMetrics'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/server/time:
    get:
      summary: Get server time information
      description: Retrieve current server time in both UTC and Asia/Manila timezones for synchronization verification
      tags:
        - System
      responses:
        '200':
          description: Server time information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerTime'

  /api/docs:
    get:
      summary: Get API documentation
      description: Retrieve interactive API documentation
      tags:
        - Documentation
      responses:
        '200':
          description: API documentation retrieved successfully
          content:
            application/json:
              schema:
                type: object
                description: Complete API documentation object

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error type
          example: "Bad Request"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid date format. Use YYYY-MM-DD format."

    SystemStatus:
      type: object
      properties:
        success:
          type: boolean
          example: true
        connection:
          type: object
          properties:
            status:
              type: string
              enum: [connected, disconnected]
              example: "connected"
            api_url:
              type: string
              example: "http://localhost:5050"
            last_test:
              type: string
              format: date-time
        devices:
          type: array
          items:
            $ref: '#/components/schemas/Device'
        alignment:
          type: object
          properties:
            primary_device_id:
              type: string
              example: "2401058352"
            primary_device_name:
              type: string
              example: "Primary Terminal (Users 1-8)"
            expected_users:
              type: array
              items:
                type: integer
              example: [1, 2, 3, 4, 5, 6, 7, 8]
            primary_device_users:
              type: array
              items:
                type: integer
              example: [1, 2, 3, 4, 5, 7, 8]
            missing_users:
              type: array
              items:
                type: integer
              example: [6]
            extra_users:
              type: array
              items:
                type: integer
              example: []
            alignment_status:
              type: string
              enum: [PERFECT, NEEDS_ATTENTION]
              example: "NEEDS_ATTENTION"
        connections:
          type: object
          properties:
            total_active_employees:
              type: integer
              example: 60
            employees_with_biometric_id:
              type: integer
              example: 60
            connection_rate_percent:
              type: integer
              example: 100
            duplicate_biometric_ids_count:
              type: integer
              example: 0
        sync:
          type: object
          properties:
            enabled:
              type: boolean
              example: true
            statistics:
              type: object
              properties:
                total_synced_today:
                  type: integer
                  example: 120
                primary_device_logs_today:
                  type: integer
                  example: 25
        webhook:
          type: object
          properties:
            enabled:
              type: boolean
              example: true
            url:
              type: string
              example: "http://your-hris-server:8000/api/biometric/webhook"
            mode:
              type: string
              enum: [sync, async]
              example: "sync"
            rate_limit:
              type: integer
              example: 60
            timeout:
              type: integer
              example: 30
            retry_enabled:
              type: boolean
              example: true

    AttendanceLogsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        total:
          type: integer
          description: Total number of logs available
          example: 120
        returned:
          type: integer
          description: Number of logs returned in this response
          example: 3
        primary_device:
          type: string
          example: "2401058352"
        logs:
          type: array
          items:
            $ref: '#/components/schemas/AttendanceLog'

    AttendanceLog:
      type: object
      properties:
        id:
          type: integer
          description: Database record ID
          example: 123
        user_id:
          type: integer
          description: User ID (1-8 for primary device)
          example: 5
        device_id:
          type: string
          description: Biometric device ID
          example: "2401058352"
        device_type:
          type: string
          enum: [PRIMARY, SECONDARY]
          description: Device classification
          example: "PRIMARY"
        is_primary:
          type: boolean
          description: Whether this is from the primary device
          example: true
        timestamp:
          type: string
          description: Original device timestamp (YYYYMMDDHHMMSS)
          example: "20251022081722"
        datetime_utc:
          type: string
          description: UTC datetime (server storage format)
          example: "2025-10-22 08:17:22"
        datetime_local:
          type: string
          description: Asia/Manila datetime (display format)
          example: "2025-10-22 16:17:22"
        timezone:
          type: string
          description: Timezone identifier
          example: "Asia/Manila"
        direction:
          type: string
          enum: [in, out]
          description: Attendance direction (alternates per user)
          example: "in"
        verification_method:
          type: string
          description: Biometric verification method used
          example: "Fingerprint"
        created_at:
          type: string
          description: Database record creation timestamp
          example: "2025-10-22 08:17:22"

    UsersResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        total:
          type: integer
          description: Total number of users available
          example: 8
        returned:
          type: integer
          description: Number of users returned in this response
          example: 8
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        user_id:
          type: integer
          description: Unique user identifier (1-8 for this system)
          example: 5
        privilege:
          type: integer
          description: User privilege level
          example: 0
        enabled:
          type: integer
          description: User enabled status (1=enabled, 0=disabled)
          example: 1
        password_flag:
          type: integer
          description: Password authentication flag
          example: 0
        card_flag:
          type: integer
          description: Card authentication flag
          example: 0
        face_flag:
          type: integer
          description: Face authentication flag
          example: 0
        fp_count:
          type: integer
          description: Number of enrolled fingerprints
          example: 2
        vein_count:
          type: integer
          description: Number of enrolled vein patterns
          example: 0
        enrolled_backups:
          type: array
          description: List of enrolled backup templates
          items:
            type: string
          example: ["template1", "template2"]
        updated_at:
          type: string
          description: Last update timestamp
          example: "2025-10-22 08:00:00"

    DevicesResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        total:
          type: integer
          description: Total number of devices
          example: 2
        devices:
          type: array
          items:
            $ref: '#/components/schemas/Device'

    Device:
      type: object
      properties:
        device_id:
          type: string
          description: Unique device identifier
          example: "2401058352"
        device_name:
          type: string
          description: Human-readable device name
          example: "Primary Terminal (Users 1-8)"
        status:
          type: string
          description: Device status (allowed/blocked)
          example: "allowed"
        last_seen:
          type: string
          description: Last communication timestamp
          example: "2025-10-22 14:06:23"
        connection_status:
          type: string
          description: Current connection status
          enum: [connected, recent, offline, never]
          example: "connected"
        is_primary:
          type: boolean
          description: Whether this is the primary device
          example: true
        device_type:
          type: string
          enum: [PRIMARY, SECONDARY]
          description: Device classification
          example: "PRIMARY"
        created_at:
          type: string
          description: Device creation timestamp
          example: "2025-10-22 08:00:00"

    WebhookStatus:
      type: object
      properties:
        success:
          type: boolean
          example: true
        webhook:
          type: object
          properties:
            enabled:
              type: boolean
              example: true
            url:
              type: string
              example: "http://your-hris-server:8000/api/biometric/webhook"
            mode:
              type: string
              enum: [sync, async]
              example: "sync"
            rate_limit:
              type: integer
              example: 60
            timeout:
              type: integer
              example: 30
            retry_enabled:
              type: boolean
              example: true
            queue_size:
              type: integer
              description: Number of webhooks in async queue
              example: 0
            stats:
              type: object
              properties:
                sent:
                  type: integer
                  description: Total webhooks sent successfully
                  example: 150
                failed:
                  type: integer
                  description: Total webhook delivery failures
                  example: 2
                retried:
                  type: integer
                  description: Total retry attempts
                  example: 1
                rate_limited:
                  type: integer
                  description: Total rate limit hits
                  example: 0
        timestamp:
          type: string
          format: date-time

    PerformanceMetrics:
      type: object
      properties:
        success:
          type: boolean
          example: true
        performance:
          type: object
          properties:
            cache:
              type: object
              properties:
                user_direction_cache_size:
                  type: integer
                  description: Number of users in direction cache
                  example: 8
            webhooks:
              type: object
              properties:
                sent:
                  type: integer
                  example: 150
                failed:
                  type: integer
                  example: 2
                retried:
                  type: integer
                  example: 1
                rate_limited:
                  type: integer
                  example: 0
            system:
              type: object
              properties:
                uptime_seconds:
                  type: integer
                  description: Server uptime in seconds
                  example: 3600
                memory_usage_mb:
                  type: integer
                  description: Current memory usage in MB
                  example: 45
        timestamp:
          type: string
          format: date-time

    ServerTime:
      type: object
      properties:
        success:
          type: boolean
          example: true
        server_timezone:
          type: string
          example: "UTC"
        display_timezone:
          type: string
          example: "Asia/Manila"
        current_time:
          type: object
          properties:
            utc:
              type: string
              description: Current UTC time
              example: "2025-10-22 08:17:52"
            local:
              type: string
              description: Current Asia/Manila time
              example: "2025-10-22 16:17:52"
            utc_iso:
              type: string
              format: date-time
              description: UTC time in ISO format
              example: "2025-10-22T08:17:52.000000+00:00"
            local_iso:
              type: string
              format: date-time
              description: Local time in ISO format
              example: "2025-10-22T16:17:52.000000+08:00"
        timezone_offset:
          type: object
          properties:
            utc_to_local_hours:
              type: integer
              example: 8
            description:
              type: string
              example: "Asia/Manila is UTC+8"
        timestamp:
          type: string
          format: date-time

    TestLogResponse:
      type: object
      description: Simple response matching real device processing
      properties:
        success:
          type: boolean
          example: true
        user_id:
          type: integer
          description: Employee ID that was processed
          example: 5
        direction:
          type: string
          enum: [IN, OUT]
          description: Time-in (IN) or Time-out (OUT) - automatically alternated per user
          example: "IN"
        device_id:
          type: string
          description: Biometric device ID that processed the attendance
          example: "2401058352"
        timestamp:
          type: string
          description: Local timestamp (Asia/Manila) when attendance was recorded
          example: "2025-10-22 16:17:52"
